{
    "contents" : "# GROUP 7 - Predicting Auto Insurance Loss\n# \n# Objective: \n# The objective of this project is to analyze historical insurance data to find predictive variables that will ultimately predict an insurance company's future losses.\n\n# Data dictionary and source\n\n# Variable Description\n# ----------------------\n# Age | Age of policy holder\n# Age.Band | Age groups of 16-25, 26-59, and 60+\n# Years of Driving Experience | Years driven \n# Number of Vehicles  | Number of Cars insured under policy \n# Gender | M/F\n# Married | Married/Single\n# Vehicle Age | Age of vehicle insured under policy\n# Vehicle Age Band | Groups of Vehicle Age\n# Fuel Type | Petro/Diesel\n# Losses | Loss claimed under policy\n# \n# The data come from an auto insurance company in India, where variables and the background are provided.\n# \n# Dataset summary\n\n# LOAD LIBRARY\ninstall.packages(\"lmtest\")\ninstall.packages(\"sandwich\")\ninstall.packages(\"plyr\")\ninstall.packages(\"ggplot2\")\nlibrary(\"lmtest\")\nlibrary(\"sandwich\")\nlibrary(\"plyr\")\nlibrary(\"ggplot2\")\n\n# READ THE DATASET\n```{r}\nrm(list=ls())\nInsuranceData=read.csv(file=\"Insurance Data Updated.csv\")\n```\n\n```{r}\nsummary(InsuranceData)\n```\n\n# Sampling (Split Dataset Randomly)\n### Next we sample 80% of the original data and use it as the training set. The remaining 20% is used as test set. The regression model will be built on the training set and future performance of your model will be evaluated with the test set.\n\n```{r}\nset.seed(1000)\nsubset <- sample(nrow(InsuranceData),nrow(InsuranceData)*0.80)\nInsurance_train = InsuranceData[subset,]\nInsurance_test = InsuranceData[-subset,]\nattach(Insurance_train)\n```\n\n# Response Variable Exploration\n\n# Plot of Losses\n```{r}\nplot(Losses,col=rgb(74,126,187,max=255),pch=18,ylab=\"Losses\",xlab=\"No. of Records\")\ngrid(nx=NA,ny=NULL,col=rgb(165,165,165,max=255),lty=1)\n```\n\n# Histogram of Losses\n```{r}\nhist(Losses,breaks=100, xlab=\"Losses (00s)\",ylab=\"Density of Policy\", main=\"Distribution of Losses\",col=rgb(218,238,243,max=255),border=0,prob=TRUE)\ncurve(dnorm(x,mean=mean(Losses),sd=sd(Losses)),col=\"red\",lwd=2,add=TRUE)\nlines(density(Losses,adjust=3),col=rgb(112,48,160,max=255),lwd=2)\n```\n\n```{r}\nsummary(Losses)\nquantile(Losses,c(0.05,0.1,0.25,0.5,0.75,0.9,0.95,0.975,0.99,0.995))\n```\n\n### From the plot graph, we can see quite a few outliners. From the histogram, the losses are highly skewed to the right.  Therefore, we decided to normalize the data. \n\n# Histogram of LogLosses\n```{r}\nlogloss<-log(Losses)\nhist(logloss,breaks=100, xlab=\"LogLoss\",ylab=\"Density of Policy\", main=\"Distribution of LogLoss\",col=rgb(218,238,243,max=255),border=0,prob=TRUE)\ncurve(dnorm(x,mean=mean(logloss),sd=sd(logloss)),col=\"red\",lwd=2,add=TRUE)\nlines(density(logloss,adjust=3),col=rgb(112,48,160,max=255),lwd=2)\n```\n\n# Independent Variables Analysis\n# Bivariate analysis of response agains independent variables\n```{r}\npar(mfrow=c (2, 2)) \nplot(logloss ~Age.Band,col=\"#00000033\")\nplot(logloss ~Gender,col=\"#00000033\")\nplot(logloss ~Married,col=\"#00000033\")\nplot(logloss ~Fuel.Type,col=\"#00000033\")\npar(mfrow=c (1, 1)) \nplot(logloss ~Vehicle.Age.Band,col=\"#00000033\")\n```\n\n# Age group and Gender\n```{r}\nbar<-ggplot(Insurance_train, aes(Gender,logloss,fill=Age.Band))\nbar+ stat_summary(fun.y=mean,geom=\"histogram\", position=\"dodge\", width=0.2)\n```\n\n# Age group and Marital status\n```{r}\nbar<-ggplot(Insurance_train, aes(Married, logloss,fill=Age.Band))\nbar+ stat_summary(fun.y=mean,geom=\"histogram\", position=\"dodge\", width=0.2)\n```\n\n# Find correlations between variables . Age and Driving experience has 99% correlation.\n```{r}\ncor(Years.of.Driving.Experience,Age)\ncor(logloss, Age)\ncor(logloss,Years.of.Driving.Experience)\ncor(logloss,Number.of.Vehicles)\n```\n\n# Anova Test(for unequal variances ) and T-tests\n# Comparing logloss between different age groups\n```{r}\noneway.test(logloss ~Age.Band,var.equal=F)\n```\n\n# Comparing logloss between gender\n```{r}\nt.test(logloss ~Gender)\n```\n\n# Comparing logloss between marrital status\n```{r}\nt.test(logloss ~Married)\n```\n\n# Comparing logloss between fuel type\n```{r}\nt.test(logloss ~Fuel.Type)\n```\n\n\n# Model Building and Variable Selection\n---------------------------------------\n# Initial Model\n# The following model includes all $x$ varables in the model\n```{r}\nmodel_1 <- lm(logloss ~Number.of.Vehicles+Age.Band:Years.of.Driving.Experience+Gender +Married +Vehicle.Age +Fuel.Type)\nsummary(model_1)\nstep(model_1,direction=\"backward\")\n```\n\n### Based on the results, the second model has higher AIC which implies better fitness. We then continue to evaluate it based on the value of adjusted R square. \n```{r}\nmodel_2 <- lm(logloss ~Age.Band:Years.of.Driving.Experience+Gender +Married +Vehicle.Age +Fuel.Type)\nsummary(model_2)\n```\n\n# In-Sample Model Evaluation\n\n# MSE comparison\n```{r}\nmodelone_summary <- summary(model_1)\nsummary(model_1)\nmean((modelone_summary$residuals)^2)\n```\n\n```{r}\nmodeltwo_summary <- summary(model_2)\nmean((modeltwo_summary$residuals)^2)\n```\n\n\n# R Square comparison\n# $R^2$ of the model 1\n```{r}\nmodelone_summary$adj.r.squared\n```\n\n# $R^2$ of the model 2\n```{r}\nmodeltwo_summary$adj.r.squared\n```\n\n# AIC and BIC comparison\n\n```{r}\nAIC(model_1)\nAIC(model_2)\n```\n\n```{r}\nBIC(model_1)\nBIC(model_2)\n```\n\n# Based on the result, we confirmed that model 2 is our best model.\n\n# Out-of-Sample Prediction\n### To evaluate how the model performs on future data, we use predict() to get the predicted values from the test set.\n```{r, eval=FALSE}\ntestdata <- predict(model_2, Insurance_test)\ntestdata\n```\n  \n# Mean Squared Error (MSE) Comparison\n```{r}\ntlogloss<-log(Insurance_test$Losses)\nmean((testdata - tlogloss)^2)        #MSE from 20% sample\nmean((modeltwo_summary$residuals)^2)\n```\n\n### We can see that the MSE of in-sample and out-of-sample are very close, which further proves our model 2 is a good fit.  \n\n# Diagnostics Analysis\n```{r}\npar(mfrow=c (1, 2)) \nplot(model_2)              \n```\n# Limitation: no linear relationship within age groups. \n```{r}\nmodel_a<- lm(logloss ~Age, subset=Age.Band==\"16-25\")\nsummary(model_a)\n```\n```{r}\nmodel_b<- lm(logloss ~Age, subset=Age.Band==\"26-59\")\nsummary(model_b)\n```\n```{r}\nmodel_c<- lm(logloss ~Age, subset=Age.Band==\"60+\")\nsummary(model_c)\n```\n```",
    "created" : 1417730626985.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3822751869",
    "id" : "4BC05215",
    "lastKnownWriteTime" : 1417733202,
    "path" : "C:/Stuff/Downloads/MS BSAN/Quarter 1/STAT 610/Project/statsfinalproject/statsfinalproject/MasterCopy - Final.R",
    "project_path" : "MasterCopy - Final.R",
    "properties" : {
        "notebook_author" : "Varun Pillai",
        "notebook_title" : "MasterCopy - Final.R",
        "notebook_type" : "spin"
    },
    "source_on_save" : false,
    "type" : "r_source"
}